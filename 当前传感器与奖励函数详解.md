# TITA RL å½“å‰ä¼ æ„Ÿå™¨ä¸å¥–åŠ±å‡½æ•°è¯¦è§£

## ğŸ“‹ ç›®å½•
- [1. å½“å‰ä½¿ç”¨çš„ä¼ æ„Ÿå™¨ç³»ç»Ÿ](#1-å½“å‰ä½¿ç”¨çš„ä¼ æ„Ÿå™¨ç³»ç»Ÿ)
- [2. é«˜åº¦ä¼ æ„Ÿå™¨è¯¦è§£](#2-é«˜åº¦ä¼ æ„Ÿå™¨è¯¦è§£)
- [3. å®Œæ•´å¥–åŠ±å‡½æ•°è®¾è®¡](#3-å®Œæ•´å¥–åŠ±å‡½æ•°è®¾è®¡)
- [4. çº¦æŸæˆæœ¬å‡½æ•°](#4-çº¦æŸæˆæœ¬å‡½æ•°)
- [5. è§‚æµ‹ç©ºé—´ç»„æˆ](#5-è§‚æµ‹ç©ºé—´ç»„æˆ)

---

## 1. å½“å‰ä½¿ç”¨çš„ä¼ æ„Ÿå™¨ç³»ç»Ÿ

### 1.1 ä¼ æ„Ÿå™¨æ¸…å•

TITA å½“å‰ä½¿ç”¨çš„ä¼ æ„Ÿå™¨åŒ…æ‹¬ï¼š

| ä¼ æ„Ÿå™¨ç±»å‹ | æ•°é‡ | æµ‹é‡å†…å®¹ | ç”¨é€” |
|-----------|------|---------|------|
| **IMUï¼ˆæƒ¯æ€§æµ‹é‡å•å…ƒï¼‰** | 1 | åŸºåº§è§’é€Ÿåº¦ã€é‡åŠ›æŠ•å½± | å§¿æ€æ„ŸçŸ¥ |
| **å…³èŠ‚ç¼–ç å™¨** | 8 | å…³èŠ‚ä½ç½®ã€å…³èŠ‚é€Ÿåº¦ | æœ¬ä½“æ„Ÿå— |
| **è¶³ç«¯åŠ›ä¼ æ„Ÿå™¨** | 2 | è¶³ç«¯æ¥è§¦åŠ› | æ¥è§¦æ£€æµ‹ |
| **é«˜åº¦ä¼ æ„Ÿå™¨é˜µåˆ—** | 187ç‚¹ | å‘¨å›´åœ°å½¢é«˜åº¦ | åœ°å½¢æ„ŸçŸ¥ â­ |
| **æ·±åº¦ç›¸æœºï¼ˆå¯é€‰ï¼‰** | 1 | æ·±åº¦å›¾åƒ | è§†è§‰æ„ŸçŸ¥ |

### 1.2 ä¼ æ„Ÿå™¨æ¶æ„å›¾

```
                    TITA æœºå™¨äºº
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚               â”‚               â”‚
    IMU ä¼ æ„Ÿå™¨      å…³èŠ‚ç¼–ç å™¨    è¶³ç«¯åŠ›ä¼ æ„Ÿå™¨
        â”‚               â”‚               â”‚
    è§’é€Ÿåº¦/å§¿æ€     ä½ç½®/é€Ÿåº¦        æ¥è§¦åŠ›
        â”‚               â”‚               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                â”‚               â”‚
          é«˜åº¦ä¼ æ„Ÿå™¨       æ·±åº¦ç›¸æœº
          (187ç‚¹)         (å¯é€‰)
                â”‚               â”‚
            åœ°å½¢é«˜åº¦          æ·±åº¦å›¾åƒ
```

---

## 2. é«˜åº¦ä¼ æ„Ÿå™¨è¯¦è§£

### 2.1 ä»€ä¹ˆæ˜¯é«˜åº¦ä¼ æ„Ÿå™¨ï¼Ÿ

**é«˜åº¦ä¼ æ„Ÿå™¨å¹¶éçœŸå®çš„ç‰©ç†ä¼ æ„Ÿå™¨**ï¼Œè€Œæ˜¯é€šè¿‡**åœ°å½¢ç½‘æ ¼é‡‡æ ·**å®ç°çš„è™šæ‹Ÿä¼ æ„Ÿå™¨ã€‚å®ƒæ¨¡æ‹Ÿäº†æœºå™¨äººé€šè¿‡æ¿€å…‰é›·è¾¾æˆ–å…¶ä»–æ–¹å¼æ„ŸçŸ¥å‘¨å›´åœ°å½¢é«˜åº¦çš„èƒ½åŠ›ã€‚

### 2.2 é«˜åº¦ä¼ æ„Ÿå™¨é…ç½®

åœ¨ `configs/legged_robot_config.py` ä¸­é…ç½®ï¼š

```python
class terrain:
    measure_heights = True              # å¯ç”¨é«˜åº¦æµ‹é‡
    
    # æµ‹é‡ç‚¹çš„åˆ†å¸ƒï¼ˆç›¸å¯¹æœºå™¨äººåŸºåº§ï¼‰
    measured_points_x = [
        -0.8, -0.7, -0.6, -0.5, -0.4, -0.3, -0.2, -0.1, 
        0., 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8
    ]  # å‰åæ–¹å‘ï¼š-0.8m åˆ° 0.8m (17ä¸ªç‚¹)
    
    measured_points_y = [
        -0.5, -0.4, -0.3, -0.2, -0.1, 
        0., 
        0.1, 0.2, 0.3, 0.4, 0.5
    ]  # å·¦å³æ–¹å‘ï¼š-0.5m åˆ° 0.5m (11ä¸ªç‚¹)
    
    # æ€»å…±ï¼š17 Ã— 11 = 187 ä¸ªæµ‹é‡ç‚¹
```

### 2.3 é«˜åº¦ä¼ æ„Ÿå™¨å·¥ä½œåŸç†

#### 2.3.1 æµ‹é‡ç‚¹åˆå§‹åŒ–

```python
def _init_height_points(self):
    """
    åˆ›å»ºé«˜åº¦æµ‹é‡ç‚¹ç½‘æ ¼ï¼ˆåœ¨æœºå™¨äººåŸºåº§åæ ‡ç³»ä¸‹ï¼‰
    """
    y = torch.tensor(self.cfg.terrain.measured_points_y, device=self.device)
    x = torch.tensor(self.cfg.terrain.measured_points_x, device=self.device)
    grid_x, grid_y = torch.meshgrid(x, y)
    
    # åˆ›å»ºæµ‹é‡ç‚¹çŸ©é˜µ [num_envs, 187, 3]
    self.num_height_points = grid_x.numel()  # 187
    points = torch.zeros(self.num_envs, self.num_height_points, 3, device=self.device)
    points[:, :, 0] = grid_x.flatten()  # x åæ ‡
    points[:, :, 1] = grid_y.flatten()  # y åæ ‡
    # z åæ ‡ä¸º 0ï¼ˆåœ¨åŸºåº§å¹³é¢ä¸Šï¼‰
    
    return points
```

#### 2.3.2 é«˜åº¦é‡‡æ ·è¿‡ç¨‹

```python
def _get_heights(self, env_ids=None):
    """
    ä»åœ°å½¢ç½‘æ ¼ä¸­é‡‡æ ·é«˜åº¦å€¼
    
    æ­¥éª¤ï¼š
    1. å°†æµ‹é‡ç‚¹ä»åŸºåº§åæ ‡ç³»è½¬æ¢åˆ°ä¸–ç•Œåæ ‡ç³»
    2. æ ¹æ®æœºå™¨äººä½ç½®å’Œæœå‘æ—‹è½¬æµ‹é‡ç‚¹
    3. åœ¨åœ°å½¢é«˜åº¦å›¾ä¸ŠæŸ¥è¯¢å¯¹åº”ä½ç½®çš„é«˜åº¦
    4. è¿”å› 187 ä¸ªç‚¹çš„é«˜åº¦å€¼
    """
    # 1. è·å–åŸºåº§ä½ç½®å’Œæœå‘
    if env_ids:
        base_quat = self.base_quat[env_ids]
        base_pos = self.root_states[env_ids, :3]
    else:
        base_quat = self.base_quat
        base_pos = self.root_states[:, :3]
    
    # 2. å°†æµ‹é‡ç‚¹æ—‹è½¬åˆ°ä¸–ç•Œåæ ‡ç³»ï¼ˆåªè€ƒè™‘ yaw è§’åº¦ï¼‰
    points = quat_apply_yaw(
        base_quat.repeat(1, self.num_height_points),  # é‡å¤ 187 æ¬¡
        self.height_points[env_ids] if env_ids else self.height_points
    ) + base_pos.unsqueeze(1)  # åŠ ä¸ŠåŸºåº§ä½ç½®
    
    # 3. è½¬æ¢åˆ°åœ°å½¢ç½‘æ ¼åæ ‡
    points += self.terrain.cfg.border_size
    points = (points / self.terrain.cfg.horizontal_scale).long()
    
    # 4. æå– x, y åæ ‡å¹¶é™åˆ¶èŒƒå›´
    px = points[:, :, 0].view(-1)
    py = points[:, :, 1].view(-1)
    px = torch.clip(px, 0, self.height_samples.shape[0]-2)
    py = torch.clip(py, 0, self.height_samples.shape[1]-2)
    
    # 5. ä»åœ°å½¢é«˜åº¦å›¾ä¸­é‡‡æ ·ï¼ˆä½¿ç”¨åŒçº¿æ€§æ’å€¼çš„æœ€å°å€¼ï¼‰
    heights1 = self.height_samples[px, py]
    heights2 = self.height_samples[px+1, py]
    heights3 = self.height_samples[px, py+1]
    heights = torch.min(heights1, heights2)
    heights = torch.min(heights, heights3)
    
    # 6. è¿”å›é«˜åº¦å€¼ [num_envs, 187]
    return heights.view(self.num_envs, -1) * self.terrain.cfg.vertical_scale
```

### 2.4 é«˜åº¦ä¼ æ„Ÿå™¨å¯è§†åŒ–

```
æœºå™¨äººä¿¯è§†å›¾ï¼ˆæµ‹é‡ç‚¹åˆ†å¸ƒï¼‰ï¼š

        å‰æ–¹ (+x)
           â†‘
    Â· Â· Â· Â· Â· Â· Â· Â· Â·  (0.8m)
    Â· Â· Â· Â· Â· Â· Â· Â· Â·  (0.7m)
    Â· Â· Â· Â· Â· Â· Â· Â· Â·  (0.6m)
    Â· Â· Â· Â· Â· Â· Â· Â· Â·  
    Â· Â· Â· Â· Â· Â· Â· Â· Â·  
    Â· Â· Â· Â· â— Â· Â· Â· Â·  â† æœºå™¨äººä¸­å¿ƒ
    Â· Â· Â· Â· Â· Â· Â· Â· Â·  
    Â· Â· Â· Â· Â· Â· Â· Â· Â·  
    Â· Â· Â· Â· Â· Â· Â· Â· Â·  (-0.8m)
    
â† å·¦(-y)        å³(+y) â†’
```

### 2.5 é«˜åº¦ä¿¡æ¯åœ¨è§‚æµ‹ä¸­çš„ä½¿ç”¨

```python
def compute_observations(self):
    """
    é«˜åº¦ä¿¡æ¯è¢«å½’ä¸€åŒ–ååŠ å…¥è§‚æµ‹ç©ºé—´
    """
    # ... å…¶ä»–è§‚æµ‹ ...
    
    # é«˜åº¦æµ‹é‡ï¼ˆ187 ç»´ï¼‰
    heights = torch.clip(
        self.root_states[:, 2].unsqueeze(1) - 0.4 - self.measured_heights,
        -1, 1.
    ) * self.obs_scales.height_measurements
    
    # heights çš„å«ä¹‰ï¼š
    # - self.root_states[:, 2]: æœºå™¨äººåŸºåº§é«˜åº¦
    # - self.measured_heights: 187 ä¸ªç‚¹çš„åœ°å½¢é«˜åº¦
    # - å·®å€¼ï¼šæœºå™¨äººä¸åœ°å½¢çš„ç›¸å¯¹é«˜åº¦
    # - å½’ä¸€åŒ–åˆ° [-1, 1] èŒƒå›´
```

---

## 3. å®Œæ•´å¥–åŠ±å‡½æ•°è®¾è®¡

### 3.1 å¥–åŠ±å‡½æ•°æ¶æ„

```python
def _prepare_reward_function(self):
    """
    å¥–åŠ±å‡½æ•°å‡†å¤‡æµç¨‹ï¼š
    1. ç§»é™¤æƒé‡ä¸º 0 çš„å¥–åŠ±é¡¹
    2. å°†éé›¶æƒé‡ä¹˜ä»¥æ—¶é—´æ­¥é•¿ dt
    3. ä¸ºæ¯ä¸ªå¥–åŠ±é¡¹åˆ›å»ºå¯¹åº”çš„è®¡ç®—å‡½æ•°
    """
    for key in list(self.reward_scales.keys()):
        scale = self.reward_scales[key]
        if scale == 0:
            self.reward_scales.pop(key)  # ç§»é™¤é›¶æƒé‡é¡¹
        else:
            self.reward_scales[key] *= self.dt  # ä¹˜ä»¥æ—¶é—´æ­¥
    
    # åˆ›å»ºå¥–åŠ±å‡½æ•°åˆ—è¡¨
    self.reward_functions = []
    self.reward_names = []
    for name, scale in self.reward_scales.items():
        if name == "termination":
            continue
        self.reward_names.append(name)
        name = '_reward_' + name
        self.reward_functions.append(getattr(self, name))
```

### 3.2 è¯¦ç»†å¥–åŠ±å‡½æ•°åˆ—è¡¨

#### 3.2.1 ä»»åŠ¡å¥–åŠ±ï¼ˆä¸»è¦ç›®æ ‡ï¼‰

##### 1. `_reward_tracking_lin_vel` - çº¿é€Ÿåº¦è·Ÿè¸ª â­â­â­â­â­
```python
def _reward_tracking_lin_vel(self):
    """
    å¥–åŠ±æœºå™¨äººè·Ÿè¸ªæŒ‡ä»¤çº¿é€Ÿåº¦ï¼ˆx, y æ–¹å‘ï¼‰
    
    å…¬å¼: exp(-error^2 / sigma)
    - error: æŒ‡ä»¤é€Ÿåº¦ä¸å®é™…é€Ÿåº¦çš„è¯¯å·®
    - sigma: è·Ÿè¸ªå®¹å·®ï¼ˆé»˜è®¤ 0.25ï¼‰
    
    æƒé‡: 1.0 (æœ€é«˜æƒé‡ï¼Œä¸»è¦ä»»åŠ¡)
    """
    lin_vel_error = torch.sum(
        torch.square(self.commands[:, :2] - self.base_lin_vel[:, :2]), 
        dim=1
    )
    return torch.exp(-lin_vel_error / self.cfg.rewards.tracking_sigma)
```

##### 2. `_reward_tracking_ang_vel` - è§’é€Ÿåº¦è·Ÿè¸ª â­â­â­â­
```python
def _reward_tracking_ang_vel(self):
    """
    å¥–åŠ±æœºå™¨äººè·Ÿè¸ªæŒ‡ä»¤è§’é€Ÿåº¦ï¼ˆyaw æ–¹å‘ï¼‰
    
    æƒé‡: 0.5
    """
    ang_vel_error = torch.square(
        self.commands[:, 2] - self.base_ang_vel[:, 2]
    )
    return torch.exp(-ang_vel_error / self.cfg.rewards.tracking_sigma)
```

#### 3.2.2 ç¨³å®šæ€§å¥–åŠ±/æƒ©ç½š

##### 3. `_reward_orientation` - å§¿æ€æƒ©ç½š â­â­â­
```python
def _reward_orientation(self):
    """
    æƒ©ç½šæœºå™¨äººåŸºåº§å€¾æ–œï¼ˆæ¨ªæ»šå’Œä¿¯ä»°ï¼‰
    
    ç›®æ ‡: ä¿æŒæ°´å¹³å§¿æ€
    æƒé‡: -1.0 (æƒ©ç½š)
    """
    # projected_gravity[:, :2] æ˜¯é‡åŠ›åœ¨ x-y å¹³é¢çš„æŠ•å½±
    # å¦‚æœæœºå™¨äººå®Œå…¨æ°´å¹³ï¼ŒæŠ•å½±ä¸º [0, 0]
    return torch.sum(torch.square(self.projected_gravity[:, :2]), dim=1)
```

##### 4. `_reward_base_height` - é«˜åº¦æƒ©ç½š â­â­â­
```python
def _reward_base_height(self):
    """
    æƒ©ç½šæœºå™¨äººåŸºåº§é«˜åº¦åç¦»ç›®æ ‡å€¼
    
    ä½¿ç”¨é«˜åº¦ä¼ æ„Ÿå™¨ï¼šè®¡ç®—æœºå™¨äººä¸åœ°é¢çš„å¹³å‡é«˜åº¦
    ç›®æ ‡é«˜åº¦: 0.35m (TITA é…ç½®)
    æƒé‡: -1.0 (æƒ©ç½š)
    """
    # è®¡ç®—æœºå™¨äººåŸºåº§ç›¸å¯¹åœ°å½¢çš„å¹³å‡é«˜åº¦
    base_height = torch.mean(
        self.root_states[:, 2].unsqueeze(1) - self.measured_heights,
        dim=1
    )
    # æƒ©ç½šåç¦»ç›®æ ‡é«˜åº¦
    return torch.square(base_height - self.cfg.rewards.base_height_target)
```

##### 5. `_reward_lin_vel_z` - å‚ç›´é€Ÿåº¦æƒ©ç½š
```python
def _reward_lin_vel_z(self):
    """
    æƒ©ç½šå‚ç›´æ–¹å‘é€Ÿåº¦ï¼ˆé¿å…è·³è·ƒæˆ–ä¸‹æ²‰ï¼‰
    
    æƒé‡: -0.0 (å½“å‰ç¦ç”¨ï¼Œè·‘é…·æ—¶éœ€è¦è°ƒæ•´)
    """
    return torch.square(self.base_lin_vel[:, 2])
```

##### 6. `_reward_ang_vel_xy` - æ¨ªæ»š/ä¿¯ä»°è§’é€Ÿåº¦æƒ©ç½š
```python
def _reward_ang_vel_xy(self):
    """
    æƒ©ç½šæ¨ªæ»šå’Œä¿¯ä»°æ–¹å‘çš„è§’é€Ÿåº¦ï¼ˆé¿å…æ™ƒåŠ¨ï¼‰
    
    æƒé‡: -0.05
    """
    return torch.sum(torch.square(self.base_ang_vel[:, :2]), dim=1)
```

#### 3.2.3 èƒ½é‡æ•ˆç‡å¥–åŠ±

##### 7. `_reward_torques` - åŠ›çŸ©æƒ©ç½š
```python
def _reward_torques(self):
    """
    æƒ©ç½šå¤§åŠ›çŸ©è¾“å‡ºï¼ˆèŠ‚èƒ½ï¼‰
    
    æƒé‡: 0.0 (å½“å‰ç¦ç”¨)
    """
    return torch.sum(torch.square(self.torques), dim=1)
```

##### 8. `_reward_powers` - åŠŸç‡æƒ©ç½š â­â­
```python
def _reward_powers(self):
    """
    æƒ©ç½šåŠŸç‡æ¶ˆè€— = åŠ›çŸ© Ã— è§’é€Ÿåº¦
    
    æ›´ç²¾ç¡®çš„èƒ½é‡æ¶ˆè€—åº¦é‡
    æƒé‡: -2e-5
    """
    return torch.sum(
        torch.multiply(self.torques, self.dof_vel), 
        dim=1
    )
```

#### 3.2.4 è¿åŠ¨å¹³æ»‘æ€§å¥–åŠ±

##### 9. `_reward_dof_vel` - å…³èŠ‚é€Ÿåº¦æƒ©ç½š
```python
def _reward_dof_vel(self):
    """
    æƒ©ç½šé«˜å…³èŠ‚é€Ÿåº¦ï¼ˆé¿å…å‰§çƒˆè¿åŠ¨ï¼‰
    
    æƒé‡: 0.0 (å½“å‰ç¦ç”¨)
    """
    return torch.sum(torch.square(self.dof_vel), dim=1)
```

##### 10. `_reward_dof_acc` - å…³èŠ‚åŠ é€Ÿåº¦æƒ©ç½š â­â­
```python
def _reward_dof_acc(self):
    """
    æƒ©ç½šé«˜å…³èŠ‚åŠ é€Ÿåº¦ï¼ˆå¹³æ»‘è¿åŠ¨ï¼‰
    
    è®¡ç®—: (vel_t - vel_{t-1}) / dt
    æƒé‡: -2.5e-7
    """
    return torch.sum(
        torch.square((self.last_dof_vel - self.dof_vel) / self.dt), 
        dim=1
    )
```

##### 11. `_reward_action_rate` - åŠ¨ä½œå˜åŒ–ç‡æƒ©ç½š â­â­
```python
def _reward_action_rate(self):
    """
    æƒ©ç½šç›¸é‚»æ—¶åˆ»åŠ¨ä½œçš„å˜åŒ–ï¼ˆå¹³æ»‘æ§åˆ¶ï¼‰
    
    æƒé‡: -0.01
    """
    return torch.sum(
        torch.square(self.last_actions - self.actions), 
        dim=1
    )
```

##### 12. `_reward_action_smoothness` - åŠ¨ä½œå¹³æ»‘æ€§
```python
def _reward_action_smoothness(self):
    """
    æƒ©ç½šåŠ¨ä½œçš„äºŒé˜¶å·®åˆ†ï¼ˆåŠ é€Ÿåº¦ï¼‰
    
    è®¡ç®—: (a_t - 2*a_{t-1} + a_{t-2})^2
    æƒé‡: 0.0 (å½“å‰ç¦ç”¨)
    """
    return torch.sum(
        torch.square(
            self.action_history_buf[:,-1,:] - 
            2*self.action_history_buf[:,-2,:] + 
            self.action_history_buf[:,-3,:]
        ), 
        dim=1
    )
```

#### 3.2.5 æ­¥æ€å¥–åŠ±

##### 13. `_reward_feet_air_time` - è…¾ç©ºæ—¶é—´å¥–åŠ± â­â­â­
```python
def _reward_feet_air_time(self):
    """
    å¥–åŠ±è¶³éƒ¨æœ‰ä¸€å®šè…¾ç©ºæ—¶é—´ï¼ˆé¼“åŠ±åŠ¨æ€æ­¥æ€ï¼‰
    
    ç›®æ ‡: æ¯æ¬¡è¿ˆæ­¥æœ‰ 0.5 ç§’è…¾ç©ºæ—¶é—´
    æƒé‡: 0.0 (å½“å‰ç¦ç”¨ï¼Œè·‘é…·æ—¶åº”å¯ç”¨)
    
    å®ç°:
    1. æ£€æµ‹è¶³éƒ¨æ¥è§¦
    2. ç´¯è®¡è…¾ç©ºæ—¶é—´
    3. åœ¨é¦–æ¬¡æ¥è§¦åœ°é¢æ—¶ç»™äºˆå¥–åŠ±
    """
    # æ£€æµ‹æ¥è§¦ï¼ˆåŠ›ä¼ æ„Ÿå™¨ï¼‰
    contact = self.contact_forces[:, self.feet_indices, 2] > 1.
    contact_filt = torch.logical_or(contact, self.last_contacts)
    self.last_contacts = contact
    
    # æ£€æµ‹é¦–æ¬¡æ¥è§¦
    first_contact = (self.feet_air_time > 0.) * contact_filt
    self.feet_air_time += self.dt
    
    # å¥–åŠ±è…¾ç©ºæ—¶é—´ - 0.5 ç§’ï¼ˆåªåœ¨é¦–æ¬¡æ¥è§¦æ—¶ï¼‰
    rew_airTime = torch.sum(
        (self.feet_air_time - 0.5) * first_contact, 
        dim=1
    )
    
    # åªåœ¨æœ‰è¿åŠ¨æŒ‡ä»¤æ—¶ç»™å¥–åŠ±
    rew_airTime *= torch.norm(self.commands[:, :2], dim=1) > 0.1
    
    # é‡ç½®è…¾ç©ºæ—¶é—´
    self.feet_air_time *= ~contact_filt
    
    return rew_airTime
```

##### 14. `_reward_stumble` - ç»Šå€’æƒ©ç½š
```python
def _reward_stumble(self):
    """
    æƒ©ç½šè¶³éƒ¨æ’å‡»å‚ç›´è¡¨é¢ï¼ˆç»Šå€’ï¼‰
    
    æ£€æµ‹: æ°´å¹³æ¥è§¦åŠ› > 5 Ã— å‚ç›´æ¥è§¦åŠ›
    æƒé‡: 0.0 (å½“å‰ç¦ç”¨)
    """
    return torch.any(
        torch.norm(self.contact_forces[:, self.feet_indices, :2], dim=2) > 
        5 * torch.abs(self.contact_forces[:, self.feet_indices, 2]), 
        dim=1
    )
```

##### 15. `_reward_foot_clearance` - è¶³ç«¯ç¦»åœ°é«˜åº¦ ğŸ†•
```python
def _reward_foot_clearance(self):
    """
    æƒ©ç½šè¶³éƒ¨é«˜åº¦åç¦»ç›®æ ‡å€¼
    
    ä½¿ç”¨é«˜åº¦ä¼ æ„Ÿå™¨ï¼šè®¡ç®—è¶³éƒ¨ç›¸å¯¹åœ°å½¢çš„é«˜åº¦
    ç›®æ ‡é«˜åº¦: 0.0948m (ç«™ç«‹é«˜åº¦)
    æƒé‡: -0.0 (å½“å‰ç¦ç”¨)
    
    ç”¨é€”: å¯ç”¨äºè®­ç»ƒç‰¹å®šæ­¥æ€æˆ–è·¨è¶Šéšœç¢
    """
    # è®¡ç®—æ¯åªè„šç›¸å¯¹ 187 ä¸ªæµ‹é‡ç‚¹çš„å¹³å‡é«˜åº¦
    foot_height = torch.mean(
        self.foot_positions[:, :, 2].unsqueeze(1).repeat(1, self.num_height_points, 1) - 
        self.measured_heights.unsqueeze(2), 
        dim=1
    )
    
    target_height = 0.0948
    return torch.sum(torch.square(target_height - foot_height), dim=-1)
```

#### 3.2.6 å®‰å…¨æ€§å¥–åŠ±

##### 16. `_reward_collision` - ç¢°æ’æƒ©ç½š â­â­â­â­
```python
def _reward_collision(self):
    """
    æƒ©ç½šä¸åº”æ¥è§¦åœ°é¢çš„èº«ä½“éƒ¨ä½å‘ç”Ÿç¢°æ’
    
    ä¾‹å¦‚: å°è…¿ã€å¤§è…¿ç­‰ï¼ˆåœ¨é…ç½®ä¸­æŒ‡å®šï¼‰
    æƒé‡: -1.0
    """
    return torch.sum(
        1.0 * (torch.norm(
            self.contact_forces[:, self.penalised_contact_indices, :], 
            dim=-1
        ) > 0.1), 
        dim=1
    )
```

##### 17. `_reward_termination` - ç»ˆæ­¢æƒ©ç½š â­â­â­â­â­
```python
def _reward_termination(self):
    """
    æƒ©ç½šæå‰ç»ˆæ­¢ï¼ˆæ‘”å€’ç­‰ï¼‰
    
    æƒé‡: -200 (å·¨å¤§æƒ©ç½š)
    """
    return self.reset_buf * ~self.time_out_buf
```

##### 18. `_reward_feet_contact_forces` - è¶³ç«¯æ¥è§¦åŠ›æƒ©ç½š
```python
def _reward_feet_contact_forces(self):
    """
    æƒ©ç½šè¿‡å¤§çš„è¶³ç«¯æ¥è§¦åŠ›ï¼ˆé¿å…å†²å‡»ï¼‰
    
    æœ€å¤§å…è®¸æ¥è§¦åŠ›: 500 N
    æƒé‡: 0.1
    """
    return torch.sum(
        (torch.norm(self.contact_forces[:, self.feet_indices, :], dim=-1) - 
         self.cfg.rewards.max_contact_force).clip(min=0.), 
        dim=1
    )
```

#### 3.2.7 é™åˆ¶æƒ©ç½š

##### 19. `_reward_dof_pos_limits` - å…³èŠ‚ä½ç½®é™åˆ¶
```python
def _reward_dof_pos_limits(self):
    """
    æƒ©ç½šå…³èŠ‚ä½ç½®æ¥è¿‘æé™
    
    è½¯é™åˆ¶: é˜²æ­¢å…³èŠ‚è¶…å‡ºå®‰å…¨èŒƒå›´
    """
    # ä¸‹é™æƒ©ç½š
    out_of_limits = -(self.dof_pos - self.dof_pos_limits[:, 0]).clip(max=0.)
    # ä¸Šé™æƒ©ç½š
    out_of_limits += (self.dof_pos - self.dof_pos_limits[:, 1]).clip(min=0.)
    
    return torch.sum(out_of_limits, dim=1)
```

##### 20. `_reward_dof_vel_limits` - å…³èŠ‚é€Ÿåº¦é™åˆ¶
```python
def _reward_dof_vel_limits(self):
    """
    æƒ©ç½šå…³èŠ‚é€Ÿåº¦æ¥è¿‘æé™
    
    æœ€å¤§è¯¯å·®è£å‰ª: 1 rad/sï¼ˆé¿å…è¿‡å¤§æƒ©ç½šï¼‰
    """
    return torch.sum(
        (torch.abs(self.dof_vel) - 
         self.dof_vel_limits * self.cfg.rewards.soft_dof_vel_limit
        ).clip(min=0., max=1.), 
        dim=1
    )
```

##### 21. `_reward_torque_limits` - åŠ›çŸ©é™åˆ¶
```python
def _reward_torque_limits(self):
    """
    æƒ©ç½šåŠ›çŸ©æ¥è¿‘ç”µæœºæé™
    
    ä¿æŠ¤ç”µæœºï¼Œé¿å…è¿‡è½½
    """
    return torch.sum(
        (torch.abs(self.torques) - 
         self.torque_limits * self.cfg.rewards.soft_torque_limit
        ).clip(min=0.), 
        dim=1
    )
```

#### 3.2.8 å…¶ä»–å¥–åŠ±

##### 22. `_reward_stand_still` - é™æ­¢æƒ©ç½š
```python
def _reward_stand_still(self):
    """
    å½“é€Ÿåº¦æŒ‡ä»¤ä¸ºé›¶æ—¶ï¼Œæƒ©ç½šå…³èŠ‚è¿åŠ¨
    
    ç›®æ ‡: ç«™ç«‹ä¸åŠ¨
    æƒé‡: -0.0 (å½“å‰ç¦ç”¨)
    """
    return torch.sum(
        torch.abs(self.dof_pos[:, [0,1,2,4,5,6]] - 
                  self.default_dof_pos[:, [0,1,2,4,5,6]]), 
        dim=1
    ) * (torch.norm(self.commands[:, :2], dim=1) < 0.1)
```

### 3.3 å½“å‰é…ç½®çš„å®Œæ•´å¥–åŠ±æƒé‡

```python
# configs/tita_constraint_config.py
class rewards.scales:
    # ä»»åŠ¡å¥–åŠ±
    tracking_lin_vel = 1.0      # â­ ä¸»è¦ä»»åŠ¡ï¼šè·Ÿè¸ªçº¿é€Ÿåº¦
    tracking_ang_vel = 0.5      # â­ è·Ÿè¸ªè§’é€Ÿåº¦
    
    # ç¨³å®šæ€§
    orientation = -1.0          # â­ ä¿æŒæ°´å¹³å§¿æ€
    base_height = -1.0          # â­ ä¿æŒç›®æ ‡é«˜åº¦
    lin_vel_z = -0.0            # ç¦ç”¨ï¼ˆè·‘é…·æ—¶éœ€è°ƒæ•´ï¼‰
    ang_vel_xy = -0.05          # é™åˆ¶æ¨ªæ»š/ä¿¯ä»°è§’é€Ÿåº¦
    
    # èƒ½é‡æ•ˆç‡
    torques = 0.0               # ç¦ç”¨
    powers = -2e-5              # â­ æƒ©ç½šåŠŸç‡æ¶ˆè€—
    
    # è¿åŠ¨å¹³æ»‘æ€§
    dof_vel = 0.0               # ç¦ç”¨
    dof_acc = -2.5e-7           # â­ å¹³æ»‘å…³èŠ‚è¿åŠ¨
    action_rate = -0.01         # â­ å¹³æ»‘æ§åˆ¶è¾“å‡º
    action_smoothness = 0       # ç¦ç”¨
    
    # æ­¥æ€
    feet_air_time = 0.0         # ç¦ç”¨ï¼ˆè·‘é…·æ—¶éœ€å¯ç”¨ï¼‰
    foot_clearance = -0.0       # ç¦ç”¨
    
    # å®‰å…¨æ€§
    collision = -1.0            # â­ é¿å…ç¢°æ’
    termination = -200          # â­â­â­ å·¨å¤§æƒ©ç½š
    feet_stumble = -0.0         # ç¦ç”¨
    
    # å…¶ä»–
    stand_still = -0.0          # ç¦ç”¨
```

### 3.4 å¥–åŠ±è®¡ç®—æµç¨‹

```python
def compute_reward(self):
    """
    è®¡ç®—æ€»å¥–åŠ± = Î£ (reward_function_i Ã— scale_i)
    """
    self.rew_buf[:] = 0.
    
    for i in range(len(self.reward_functions)):
        name = self.reward_names[i]
        rew = self.reward_functions[i]() * self.reward_scales[name]
        self.rew_buf += rew
        self.episode_sums[name] += rew
    
    # å¯é€‰ï¼šä»…ä¿ç•™æ­£å¥–åŠ±
    if self.cfg.rewards.only_positive_rewards:
        self.rew_buf[:] = torch.clip(self.rew_buf[:], min=0.)
    
    # æ·»åŠ ç»ˆæ­¢æƒ©ç½š
    self.rew_buf += self.reward_scales['termination'] * \
                    self.reset_buf * ~self.time_out_buf
```

---

## 4. çº¦æŸæˆæœ¬å‡½æ•°

é™¤äº†å¥–åŠ±å‡½æ•°ï¼ŒTITA è¿˜ä½¿ç”¨äº†**æˆæœ¬å‡½æ•°**ï¼ˆç”¨äº NP3O ç®—æ³•çš„çº¦æŸä¼˜åŒ–ï¼‰ã€‚

### 4.1 æˆæœ¬å‡½æ•°åˆ—è¡¨

```python
# configs/tita_constraint_config.py
class costs.scales:
    pos_limit = 0.3              # å…³èŠ‚ä½ç½®é™åˆ¶è¿å
    torque_limit = 0.3           # åŠ›çŸ©é™åˆ¶è¿å
    dof_vel_limits = 0.3         # å…³èŠ‚é€Ÿåº¦é™åˆ¶è¿å
    acc_smoothness = 0.1         # åŠ é€Ÿåº¦å¹³æ»‘æ€§
    feet_contact_forces = 0.1    # è¶³ç«¯æ¥è§¦åŠ›
    stumble = 0.1                # ç»Šå€’

class costs.d_values:
    pos_limit = 0.0              # ä½ç½®é™åˆ¶å®¹å·®
    torque_limit = 0.0           # åŠ›çŸ©é™åˆ¶å®¹å·®
    dof_vel_limits = 0.0         # é€Ÿåº¦é™åˆ¶å®¹å·®
    acc_smoothness = 0.0         # åŠ é€Ÿåº¦å®¹å·®
    feet_contact_forces = 0.0    # æ¥è§¦åŠ›å®¹å·®
    stumble = 0.0                # ç»Šå€’å®¹å·®
```

### 4.2 æˆæœ¬å‡½æ•°ä¸å¥–åŠ±å‡½æ•°çš„åŒºåˆ«

| ç‰¹æ€§ | å¥–åŠ±å‡½æ•° | æˆæœ¬å‡½æ•° |
|------|---------|---------|
| **ç›®çš„** | æœ€å¤§åŒ–æ€§èƒ½ | æ»¡è¶³çº¦æŸ |
| **ä¼˜åŒ–ç®—æ³•** | PPO | NP3O (å¸¦çº¦æŸ) |
| **å¤„ç†æ–¹å¼** | ç›´æ¥ä¼˜åŒ– | çº¦æŸä¼˜åŒ– |
| **è¿ååæœ** | å‡å°‘å¥–åŠ± | å¢åŠ æˆæœ¬ |

---

## 5. è§‚æµ‹ç©ºé—´ç»„æˆ

### 5.1 å®Œæ•´è§‚æµ‹ç©ºé—´

```python
# configs/tita_constraint_config.py
class env:
    n_scan = 187                # é«˜åº¦ä¼ æ„Ÿå™¨ç‚¹æ•° â­
    n_priv_latent = 36          # ç‰¹æƒä¿¡æ¯æ½œå˜é‡
    n_proprio = 33              # æœ¬ä½“æ„Ÿå—
    history_len = 10            # å†å²é•¿åº¦
    
    num_observations = (
        n_proprio +                  # 33
        n_scan +                     # 187 (é«˜åº¦)
        history_len * n_proprio +    # 330 (å†å²)
        n_priv_latent               # 36
    )  # æ€»å…±: 586 ç»´
```

### 5.2 æœ¬ä½“æ„Ÿå—è§‚æµ‹ (33ç»´)

```python
obs_buf = torch.cat((
    self.base_ang_vel * self.obs_scales.ang_vel,        # [3] åŸºåº§è§’é€Ÿåº¦
    self.projected_gravity,                             # [3] é‡åŠ›æŠ•å½±
    self.commands[:, :3] * self.commands_scale,         # [3] é€Ÿåº¦æŒ‡ä»¤
    self.reindex((self.dof_pos - self.default_dof_pos) * self.obs_scales.dof_pos),  # [8] å…³èŠ‚ä½ç½®
    self.reindex(self.dof_vel * self.obs_scales.dof_vel),                            # [8] å…³èŠ‚é€Ÿåº¦
    self.action_history_buf[:,-1]                       # [8] å†å²åŠ¨ä½œ
), dim=-1)
```

### 5.3 é«˜åº¦æ‰«æè§‚æµ‹ (187ç»´) â­

```python
# æ¥è‡ªé«˜åº¦ä¼ æ„Ÿå™¨
heights = torch.clip(
    self.root_states[:, 2].unsqueeze(1) - 0.4 - self.measured_heights,
    -1, 1.
) * self.obs_scales.height_measurements  # [187]
```

### 5.4 å†å²è§‚æµ‹ (330ç»´)

```python
# è¿‡å» 10 ä¸ªæ—¶é—´æ­¥çš„æœ¬ä½“æ„Ÿå—
history = self.obs_history_buf  # [num_envs, 10, 33]
```

### 5.5 ç‰¹æƒä¿¡æ¯ (36ç»´)

ä»…åœ¨è®­ç»ƒæ—¶ä½¿ç”¨ï¼ŒåŒ…æ‹¬ï¼š
- æ‘©æ“¦ç³»æ•° [1]
- è´¨é‡å‚æ•° [4]
- ç”µæœºå¼ºåº¦ [8]
- PD å‚æ•° [8+8]
- å»¶è¿Ÿä¿¡æ¯ [1]
- ç­‰ç­‰

---

## 6. æ€»ç»“å¯¹æ¯”è¡¨

### 6.1 ä¼ æ„Ÿå™¨ vs æ·±åº¦ç›¸æœº

| ç‰¹æ€§ | é«˜åº¦ä¼ æ„Ÿå™¨ï¼ˆå½“å‰ï¼‰ | æ·±åº¦ç›¸æœºï¼ˆå¯é€‰ï¼‰ |
|------|------------------|----------------|
| **å®ç°æ–¹å¼** | åœ°å½¢ç½‘æ ¼é‡‡æ · | æ¸²æŸ“æ·±åº¦å›¾åƒ |
| **æµ‹é‡ç‚¹æ•°** | 187 å›ºå®šç‚¹ | 87Ã—58=5046 åƒç´  |
| **è¦†ç›–èŒƒå›´** | 1.6m Ã— 1.0m | è§†åœºè§’å†³å®š |
| **è®¡ç®—å¼€é”€** | ä½ | é«˜ |
| **ä¿¡æ¯ä¸°å¯Œåº¦** | ä½ï¼ˆä»…é«˜åº¦ï¼‰ | é«˜ï¼ˆ3D ç»“æ„ï¼‰ |
| **é€‚ç”¨åœºæ™¯** | å¹³åœ°/ç®€å•åœ°å½¢ | å¤æ‚éšœç¢/è·‘é…· |

### 6.2 å…³é”®å¥–åŠ±æƒé‡

| å¥–åŠ±é¡¹ | æƒé‡ | é‡è¦æ€§ | ç”¨é€” |
|-------|------|--------|------|
| `tracking_lin_vel` | 1.0 | â­â­â­â­â­ | ä¸»è¦ä»»åŠ¡ |
| `tracking_ang_vel` | 0.5 | â­â­â­â­ | è½¬å‘æ§åˆ¶ |
| `orientation` | -1.0 | â­â­â­â­ | å§¿æ€ç¨³å®š |
| `base_height` | -1.0 | â­â­â­ | é«˜åº¦æ§åˆ¶ï¼ˆç”¨é«˜åº¦ä¼ æ„Ÿå™¨ï¼‰ |
| `collision` | -1.0 | â­â­â­â­ | å®‰å…¨æ€§ |
| `termination` | -200 | â­â­â­â­â­ | é¿å…æ‘”å€’ |
| `powers` | -2e-5 | â­â­ | èŠ‚èƒ½ |
| `action_rate` | -0.01 | â­â­ | å¹³æ»‘æ§åˆ¶ |

---

## 7. å¯¹æ¯”ï¼šé«˜åº¦ä¼ æ„Ÿå™¨ vs æ·±åº¦ç›¸æœºç”¨äºè·‘é…·

### 7.1 é«˜åº¦ä¼ æ„Ÿå™¨çš„å±€é™æ€§

```
é«˜åº¦ä¼ æ„Ÿå™¨æµ‹é‡ç¤ºä¾‹ï¼ˆé‡åˆ°éšœç¢ç‰©ï¼‰ï¼š

ä¿¯è§†å›¾ï¼š
    Â· Â· Â· Â· Â· Â· Â· Â· Â·
    Â· Â· Â· Â· Â· Â· Â· Â· Â·
    Â· Â· [éšœ] Â· Â· Â· Â·  â† åªèƒ½æµ‹åˆ°éšœç¢ç‰©é¡¶éƒ¨é«˜åº¦
    Â· Â· [ç¢] Â· Â· Â· Â·  
    Â· Â· [ç‰©] Â· Â· Â· Â·  
    Â· Â· Â· â— Â· Â· Â· Â· Â·  â† æœºå™¨äºº
    
é—®é¢˜ï¼š
âŒ æ— æ³•è¯†åˆ«éšœç¢ç‰©å½¢çŠ¶
âŒ æ— æ³•åˆ¤æ–­éšœç¢ç‰©å®½åº¦
âŒ éš¾ä»¥åŒºåˆ†æ–œå¡å’Œé˜¶æ¢¯
```

### 7.2 æ·±åº¦ç›¸æœºçš„ä¼˜åŠ¿

```
æ·±åº¦ç›¸æœºè§†å›¾ï¼ˆé‡åˆ°éšœç¢ç‰©ï¼‰ï¼š

æ­£é¢è§†å›¾ï¼š
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    å¤©ç©º   â”‚ â† è¿œè·ç¦»ï¼ˆç™½è‰²ï¼‰
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚  [éšœç¢]  â”‚ â† è¿‘è·ç¦»ï¼ˆæ·±è‰²ï¼‰
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚   åœ°é¢    â”‚ â† ä¸­ç­‰è·ç¦»ï¼ˆç°è‰²ï¼‰
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
ä¼˜åŠ¿ï¼š
âœ… å®Œæ•´ 3D ä¿¡æ¯
âœ… å¯è¯†åˆ«éšœç¢ç‰©å½¢çŠ¶
âœ… å¯åˆ¤æ–­è·³è·ƒé«˜åº¦
âœ… æ›´è‡ªç„¶çš„æ„ŸçŸ¥æ–¹å¼
```

---

## 8. æ·»åŠ è·‘é…·åŠŸèƒ½çš„å»ºè®®

åŸºäºå½“å‰ç³»ç»Ÿï¼Œæ·»åŠ è·‘é…·åŠŸèƒ½çš„**æ¨èæ–¹æ¡ˆ**ï¼š

### æ–¹æ¡ˆ 1: ä»…ä½¿ç”¨é«˜åº¦ä¼ æ„Ÿå™¨ï¼ˆç®€å•ï¼‰

**ä¼˜ç‚¹**ï¼š
- æ— éœ€ä¿®æ”¹ç½‘ç»œæ¶æ„
- è®¡ç®—å¼€é”€å°
- è®­ç»ƒé€Ÿåº¦å¿«

**ç¼ºç‚¹**ï¼š
- åªèƒ½å¤„ç†ç®€å•éšœç¢ç‰©
- éš¾ä»¥å­¦ä¹ ç²¾ç¡®è·³è·ƒæ—¶æœº

**å®ç°æ­¥éª¤**ï¼š
1. å¢åŠ åœ°å½¢ä¸­çš„å°é˜¶æ¯”ä¾‹
2. æ·»åŠ å¥–åŠ±ï¼š`_reward_obstacle_clearance`
3. è°ƒæ•´æƒé‡ï¼šé™ä½ `lin_vel_z` æƒ©ç½š
4. è®­ç»ƒè¯¾ç¨‹ï¼šä»ä½å°é˜¶åˆ°é«˜å°é˜¶

### æ–¹æ¡ˆ 2: æ·»åŠ æ·±åº¦ç›¸æœºï¼ˆæ¨èï¼‰ â­

**ä¼˜ç‚¹**ï¼š
- ä¿¡æ¯ä¸°å¯Œï¼Œå­¦ä¹ æ•ˆæœå¥½
- å¯å¤„ç†å¤æ‚éšœç¢ç‰©
- æ¥è¿‘çœŸå®æœºå™¨äººéƒ¨ç½²

**ç¼ºç‚¹**ï¼š
- éœ€è¦ä¿®æ”¹ç½‘ç»œæ¶æ„
- è®¡ç®—å¼€é”€å¤§
- è®­ç»ƒæ—¶é—´é•¿

**å®ç°æ­¥éª¤**ï¼š
å‚è€ƒä¸»æ–‡æ¡£ã€ŠTITA_RL_æ¶æ„è¯´æ˜ä¸æ·±åº¦ç›¸æœºè·‘é…·å¼€å‘æŒ‡å—.mdã€‹

### æ–¹æ¡ˆ 3: æ··åˆæ–¹æ¡ˆ

åŒæ—¶ä½¿ç”¨é«˜åº¦ä¼ æ„Ÿå™¨å’Œæ·±åº¦ç›¸æœºï¼š
- é«˜åº¦ä¼ æ„Ÿå™¨ï¼šè„šä¸‹åœ°å½¢
- æ·±åº¦ç›¸æœºï¼šå‰æ–¹éšœç¢ç‰©

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-11-22  
**ä½œè€…**: GitHub Copilot

ğŸ”— **ç›¸å…³æ–‡æ¡£**ï¼š
- ä¸»æ–‡æ¡£ï¼š`TITA_RL_æ¶æ„è¯´æ˜ä¸æ·±åº¦ç›¸æœºè·‘é…·å¼€å‘æŒ‡å—.md`
- é…ç½®æ–‡ä»¶ï¼š`tita_rl/configs/tita_constraint_config.py`
- ç¯å¢ƒä»£ç ï¼š`tita_rl/envs/legged_robot.py`
